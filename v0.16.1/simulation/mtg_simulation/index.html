<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Whole-plant simulation · PlantBiophysics.jl</title><meta name="title" content="Whole-plant simulation · PlantBiophysics.jl"/><meta property="og:title" content="Whole-plant simulation · PlantBiophysics.jl"/><meta property="twitter:title" content="Whole-plant simulation · PlantBiophysics.jl"/><meta name="description" content="Documentation for PlantBiophysics.jl."/><meta property="og:description" content="Documentation for PlantBiophysics.jl."/><meta property="twitter:description" content="Documentation for PlantBiophysics.jl."/><meta property="og:url" content="https://VEZY.github.io/PlantBiophysics.jl/simulation/mtg_simulation/"/><meta property="twitter:url" content="https://VEZY.github.io/PlantBiophysics.jl/simulation/mtg_simulation/"/><link rel="canonical" href="https://VEZY.github.io/PlantBiophysics.jl/simulation/mtg_simulation/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="PlantBiophysics.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">PlantBiophysics.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Getting started</span><ul><li><a class="tocitem" href="../../getting_started/get_started/">TL;DR</a></li><li><a class="tocitem" href="../../getting_started/first_fit/">Parameter fitting</a></li></ul></li><li><a class="tocitem" href="../../concepts/package_design/">Design</a></li><li><a class="tocitem" href="../../variables/">Variables</a></li><li><span class="tocitem">Models</span><ul><li><a class="tocitem" href="../../models/photosynthesis/">Photosynthesis</a></li><li><a class="tocitem" href="../../models/gs/">Stomatal conductance</a></li><li><a class="tocitem" href="../../models/energy_balance/">Energy balance</a></li><li><a class="tocitem" href="../../models/light/">Light interception</a></li></ul></li><li><a class="tocitem" href="../../climate/microclimate/">Micro-climate</a></li><li><a class="tocitem" href="../../fitting/parameter_fitting/">Tutorial: Parameter fitting</a></li><li><span class="tocitem">Tutorial: Simulation</span><ul><li><a class="tocitem" href="../first_simulation/">Simple Simulation</a></li><li><a class="tocitem" href="../several_simulation/">Several time steps</a></li><li><a class="tocitem" href="../several_objects_simulation/">Several objects</a></li><li class="is-active"><a class="tocitem" href>Whole-plant simulation</a><ul class="internal"><li><a class="tocitem" href="#Multi-scale-Tree-Graph"><span>Multi-scale Tree Graph</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../uncertainty_propagation/">Tutorial: Uncertainty propagation</a></li><li><span class="tocitem">Extending PlantBiophysics</span><ul><li><a class="tocitem" href="../../extending/implement_a_model/">Implement a model</a></li><li><a class="tocitem" href="../../extending/implement_a_process/">Implement a process</a></li></ul></li><li><a class="tocitem" href="../../functions/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorial: Simulation</a></li><li class="is-active"><a href>Whole-plant simulation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Whole-plant simulation</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/VEZY/PlantBiophysics.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/VEZY/PlantBiophysics.jl/blob/master/docs/src/simulation/mtg_simulation.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Simulation-on-a-plant-(MTG)"><a class="docs-heading-anchor" href="#Simulation-on-a-plant-(MTG)">Simulation on a plant (MTG)</a><a id="Simulation-on-a-plant-(MTG)-1"></a><a class="docs-heading-anchor-permalink" href="#Simulation-on-a-plant-(MTG)" title="Permalink"></a></h1><h2 id="Multi-scale-Tree-Graph"><a class="docs-heading-anchor" href="#Multi-scale-Tree-Graph">Multi-scale Tree Graph</a><a id="Multi-scale-Tree-Graph-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-scale-Tree-Graph" title="Permalink"></a></h2><p>The Multi-scale Tree Graph, or MTG for short is a data structure that helps represent a plant topology, and optionally its geometry.</p><p>The OPF is a file format that stores an MTG with geometry onto the disk. Let&#39;s read an example OPF using <code>read_opf()</code>, a function from the <code>PlantGeom</code> package:</p><pre><code class="language-julia hljs">using PlantGeom
mtg = read_opf(joinpath(dirname(dirname(pathof(PlantBiophysics))), &quot;test&quot;, &quot;inputs&quot;, &quot;scene&quot;, &quot;opf&quot;, &quot;coffee.opf&quot;))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">/ 1: Individual
└─ / 2: Axis
   ├─ &lt; 5: Metamer
   ├─ &lt; 799: Metamer
   │  ├─ + 800: Axis
   │  │  ├─ &lt; 806: Metamer
   │  │  │  └─ + 807: Axis
   │  │  │     ├─ / 808: Metamer
   │  │  │     ├─ &lt; 810: Metamer
   │  │  │     ├─ &lt; 814: Metamer
   │  │  │     │  ├─ + 816: Leaf
   │  │  │     │  └─ + 815: Leaf
   │  │  │     ├─ &lt; 811: Metamer
   │  │  │     │  ├─ + 813: Leaf
   │  │  │     │  └─ + 812: Leaf
   │  │  │     ├─ &lt; 809: Metamer
   │  │  │     └─ &lt; 817: Metamer
   │  │  │        └─ + 818: Leaf
   │  │  ├─ &lt; 939: Metamer
   │  │  │  ├─ + 940: Leaf
   │  │  │  └─ + 941: Leaf
   │  │  ├─ &lt; 803: Metamer
   │  │  ├─ &lt; 926: Metamer
   │  │  ├─ &lt; 936: Metamer
…</code></pre><p>The result is an MTG defining the plant at several scales using a tree graph. You can read the introduction to the MTG from <a href="https://vezy.github.io/MultiScaleTreeGraph.jl/stable/the_mtg/mtg_concept/">MultiScaleTreeGraph.jl</a>&#39;s documentation if you want to understand how it works.</p><p>Now let&#39;s import the weather data:</p><pre><code class="language-julia hljs">using PlantBiophysics, PlantSimEngine, PlantMeteo, Dates

weather = read_weather(
    joinpath(dirname(dirname(pathof(PlantMeteo))), &quot;test&quot;, &quot;data&quot;, &quot;meteo.csv&quot;),
    :temperature =&gt; :T,
    :relativeHumidity =&gt; (x -&gt; x ./ 100) =&gt; :Rh,
    :wind =&gt; :Wind,
    :atmosphereCO2_ppm =&gt; :Cₐ,
    date_format = DateFormat(&quot;yyyy/mm/dd&quot;)
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">TimeStepTable{Atmosphere{(:date, :duration,...}(3 x 29):
<span class="sgr31">╭─────┬─────────────────────┬──────────────────────┬─────────┬─────────┬────────
│<span class="sgr1"> Row │                date │             duration │       T │    Wind │       ⋯
│     │</span></span><span class="sgr1"><span class="sgr90">      Dates.DateTime </span><span class="sgr31">│</span><span class="sgr90"> Dates.CompoundPeriod </span><span class="sgr31">│</span><span class="sgr90"> Float64 </span><span class="sgr31">│</span><span class="sgr90"> Float64 </span><span class="sgr31">│</span><span class="sgr90"> Float ⋯
</span><span class="sgr31">├─────┼─────────────────────┼──────────────────────┼─────────┼─────────┼────────
│   1 │ 2016-06-12T12:00:00 │           30 minutes │    25.0 │     1.0 │ 101.3 ⋯
│   2 │ 2016-06-12T12:30:00 │           30 minutes │    26.0 │     1.5 │ 101.3 ⋯
│   3 │ 2016-06-12T13:00:00 │           30 minutes │    25.3 │     1.5 │ 101.3 ⋯
╰─────┴─────────────────────┴──────────────────────┴─────────┴─────────┴────────
</span><span class="sgr36">                                                              25 columns omitted
Metadata: `Dict{String, Any}(&quot;name&quot; =&gt; &quot;Aquiares&quot;, &quot;latitude&quot; =&gt; 15.0, &quot;altitude&quot; =&gt; 100.0, &quot;use&quot; =&gt; [:clearness], &quot;file&quot; =&gt; &quot;/home/runner/.julia/packages/PlantMeteo/1u2oP/test/data/meteo.csv&quot;)`</span></span></code></pre><p>And read the models associated to the MTG from a YAML file:</p><pre><code class="language-julia hljs">file = joinpath(dirname(dirname(pathof(PlantBiophysics))), &quot;test&quot;, &quot;inputs&quot;, &quot;models&quot;, &quot;plant_coffee.yml&quot;)
models = read_model(file)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, Tuple} with 2 entries:
  &quot;Metamer&quot; =&gt; (Translucent{Float64}(0.1, σ{Float64}(0.15, 0.9)),)
  &quot;Leaf&quot;    =&gt; (Monteith{Float64, Int64}(2, 1, 0.955, 10, 0.01), Translucent{Fl…</code></pre><p>Let&#39;s check which variables we need to provide for our model configuration:</p><pre><code class="language-julia hljs">to_initialize(models, mtg)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, Vector{Symbol}} with 1 entry:
  &quot;Leaf&quot; =&gt; [:d]</code></pre><p>OK, only the <code>&quot;Leaf&quot;</code> component must be initialized before computation for the coupled energy balance, with the characteristic dimension of the object <code>d</code>.</p><p>But we also know that the <code>Translucent</code> model reads some variables from the MTG nodes directly: the absorbed shortwave radiation flux <code>Ra_SW_f</code>, the visible sky fraction seen by the object <code>sky_fraction</code>, and the photosynthetically active absorbed radiation flux <code>Ra_PAR_f</code>. We are in luck, we used <a href="https://archimed-platform.github.io/archimed-phys-user-doc/">Archimed-ϕ</a> to compute the radiation interception of each organ in the example coffee plant we are using. So the only thing we need to do is to transform the variables given by Archimed-ϕ in each node to compute the ones we need. We use <code>transform!</code> from <code>MultiScaleTreeGraph.jl</code> to traverse the MTG and compute the right variable for each node:</p><pre><code class="language-julia hljs">using MultiScaleTreeGraph

transform!(
    mtg,
    :Ra_PAR_f =&gt; (x -&gt; fill(x, length(weather))) =&gt; :Ra_PAR_f,
    :sky_fraction =&gt; (x -&gt; fill(x, length(weather))) =&gt; :sky_fraction,
    [:Ra_PAR_f, :Ra_NIR_f] =&gt; ((x, y) -&gt; x .+ y) =&gt; :Ra_SW_f,
    (x -&gt; 0.3) =&gt; :d,
    ignore_nothing = true
)</code></pre><p>The design of <code>MultiScaleTreeGraph.transform!</code> is very close to the one from <code>DataFrames</code>. It helps us compute new variables (or attributes) from others, modify their units or rename them. Here we compute a value for each time-step by repeating the values of <code>Ra_PAR_f</code> and <code>sky_fraction</code> 3 times, and compute <code>Ra_SW_f</code> from the sum of <code>Ra_PAR_f</code> (absorbed radiation flux in the PAR) and <code>Ra_NIR_f</code> (...in the NIR). We also put a single constant value for <code>d</code>: 0.3 m.</p><p>Now let&#39;s choose the outputs we want to save. Here we choose to only output the leaf temperature <code>Tₗ</code>:</p><pre><code class="language-julia hljs">vars=Dict{String,Any}(&quot;Leaf&quot; =&gt; (:Tₗ,))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, Any} with 1 entry:
  &quot;Leaf&quot; =&gt; (:Tₗ,)</code></pre><p>Now we can run a simulation using <code>run!</code> from <code>PlantSimEngine</code>:</p><pre><code class="language-julia hljs">outs = run!(mtg, models, weather, tracked_outputs=vars);</code></pre><p>We can now extract the outputs from the simulation and store them in the MTG:</p><pre><code class="language-julia hljs">for ts in outs[&quot;Leaf&quot;]
    ts.node.Tₗ = ts.Tₗ
end</code></pre><div class="admonition is-info" id="Note-7e8a97b7d078be48"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-7e8a97b7d078be48" title="Permalink"></a></header><div class="admonition-body"><p>The outputs are stored in the MTG nodes. The node is also accessible from the simulation output as the <code>node</code> field.</p></div></div><p>And finally, we can visualize the outputs in 3D using PlantGeom&#39;s <code>plantviz</code> function:</p><pre><code class="language-julia hljs">f, ax, p = plantviz(mtg, color = :Tₗ, index = 2)
colorbar(f[1, 2], p)
f</code></pre><img src="cdbe0b09.svg" alt="Example block output"/><p>Note that we use the <code>index</code> keyword argument to select the time-step we want to visualize.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../several_objects_simulation/">« Several objects</a><a class="docs-footer-nextpage" href="../uncertainty_propagation/">Tutorial: Uncertainty propagation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Tuesday 12 August 2025 08:18">Tuesday 12 August 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
