<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Whole-plant simulation · PlantBiophysics.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://VEZY.github.io/PlantBiophysics.jl/simulation/mtg_simulation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="PlantBiophysics.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">PlantBiophysics.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Getting started</span><ul><li><a class="tocitem" href="../../getting_started/get_started/">TL;DR</a></li><li><a class="tocitem" href="../../getting_started/first_fit/">Parameter fitting</a></li></ul></li><li><a class="tocitem" href="../../concepts/package_design/">Design</a></li><li><a class="tocitem" href="../../variables/">Variables</a></li><li><span class="tocitem">Models</span><ul><li><a class="tocitem" href="../../models/photosynthesis/">Photosynthesis</a></li><li><a class="tocitem" href="../../models/gs/">Stomatal conductance</a></li><li><a class="tocitem" href="../../models/energy_balance/">Energy balance</a></li><li><a class="tocitem" href="../../models/light/">Light interception</a></li></ul></li><li><a class="tocitem" href="../../climate/microclimate/">Micro-climate</a></li><li><a class="tocitem" href="../../fitting/parameter_fitting/">Tutorial: Parameter fitting</a></li><li><span class="tocitem">Tutorial: Simulation</span><ul><li><a class="tocitem" href="../first_simulation/">Simple Simulation</a></li><li><a class="tocitem" href="../several_simulation/">Several time steps</a></li><li><a class="tocitem" href="../several_objects_simulation/">Several objects</a></li><li class="is-active"><a class="tocitem" href>Whole-plant simulation</a><ul class="internal"><li><a class="tocitem" href="#Multiscale-Tree-Graph"><span>Multiscale Tree Graph</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../uncertainty_propagation/">Tutorial: Uncertainty propagation</a></li><li><span class="tocitem">Extending PlantBiophysics</span><ul><li><a class="tocitem" href="../../extending/implement_a_model/">Implement a model</a></li><li><a class="tocitem" href="../../extending/implement_a_process/">Implement a process</a></li></ul></li><li><a class="tocitem" href="../../functions/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorial: Simulation</a></li><li class="is-active"><a href>Whole-plant simulation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Whole-plant simulation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/VEZY/PlantBiophysics.jl/blob/master/docs/src/simulation/mtg_simulation.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Simulation-on-a-plant-(MTG)"><a class="docs-heading-anchor" href="#Simulation-on-a-plant-(MTG)">Simulation on a plant (MTG)</a><a id="Simulation-on-a-plant-(MTG)-1"></a><a class="docs-heading-anchor-permalink" href="#Simulation-on-a-plant-(MTG)" title="Permalink"></a></h1><h2 id="Multiscale-Tree-Graph"><a class="docs-heading-anchor" href="#Multiscale-Tree-Graph">Multiscale Tree Graph</a><a id="Multiscale-Tree-Graph-1"></a><a class="docs-heading-anchor-permalink" href="#Multiscale-Tree-Graph" title="Permalink"></a></h2><p>The Multiscale Tree Graph, or MTG for short is a data structure that helps represent a plant topology, and optionally its geometry.</p><p>The OPF is a file format that stores an MTG with geometry onto the disk. Let&#39;s read an example OPF using <code>read_opf()</code>, a function from the <code>PlantGeom</code> package:</p><pre><code class="language-julia hljs">using PlantGeom
mtg = read_opf(joinpath(dirname(dirname(pathof(PlantBiophysics))), &quot;test&quot;, &quot;inputs&quot;, &quot;scene&quot;, &quot;opf&quot;, &quot;coffee.opf&quot;))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">/ 1: Individual
└─ / 2: Axis
   ├─ &lt; 5: Metamer
   │  └─ &lt; 799: Metamer
   │     ├─ + 800: Axis
   │     │  ├─ &lt; 806: Metamer
   │     │  │  ├─ + 807: Axis
   │     │  │  │  └─ / 808: Metamer
   │     │  │  │     └─ &lt; 810: Metamer
   │     │  │  │        └─ &lt; 814: Metamer
   │     │  │  │           ├─ + 816: Leaf
   │     │  │  │           ├─ + 815: Leaf
   │     │  │  │           └─ &lt; 811: Metamer
   │     │  │  │              ├─ + 812: Leaf
   │     │  │  │              ├─ + 813: Leaf
   │     │  │  │              └─ &lt; 809: Metamer
   │     │  │  │                 └─ &lt; 817: Metamer
   │     │  │  │                    └─ + 818: Leaf
   │     │  │  └─ &lt; 939: Metamer
   │     │  │     ├─ + 940: Leaf
   │     │  │     ├─ + 941: Leaf
   │     │  │     └─ &lt; 803: Metamer
   │     │  │        └─ &lt; 926: Metamer
   │     │  │           └─ &lt; 936: Metamer
…</code></pre><p>The result is an MTG defining the plant at several scales using a tree graph. You can read the introduction to the MTG from <a href="https://vezy.github.io/MultiScaleTreeGraph.jl/stable/the_mtg/mtg_concept/">MultiScaleTreeGraph.jl</a>&#39;s documentation if you want to understand how it works.</p><p>Now let&#39;s import the weather data:</p><pre><code class="language-julia hljs">using PlantBiophysics

weather = read_weather(
    joinpath(dirname(dirname(pathof(PlantBiophysics))), &quot;test&quot;, &quot;inputs&quot;, &quot;meteo.csv&quot;),
    :temperature =&gt; :T,
    :relativeHumidity =&gt; (x -&gt; x ./ 100) =&gt; :Rh,
    :wind =&gt; :Wind,
    :atmosphereCO2_ppm =&gt; :Cₐ,
    date_format = DateFormat(&quot;yyyy/mm/dd&quot;)
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Weather data.
Metadata: `(name = &quot;Aquiares&quot;, latitude = 15.0, altitude = 100.0, use = [:clearness], file = &quot;/home/runner/work/PlantBiophysics.jl/PlantBiophysics.jl/test/inputs/meteo.csv&quot;)`.
Data:
3×21 DataFrame
 Row │ date                 duration    T        Wind     P        Rh       Cₐ ⋯
     │ DateTime             Minute      Float64  Float64  Float64  Float64  Fl ⋯
─────┼──────────────────────────────────────────────────────────────────────────
   1 │ 2016-06-12T12:00:00  30 minutes     25.0      1.0  101.325     0.6      ⋯
   2 │ 2016-06-12T12:30:00  30 minutes     26.0      1.5  101.325     0.62
   3 │ 2016-06-12T13:00:00  30 minutes     25.3      1.5  101.325     0.58
                                                              15 columns omitted</code></pre><p>And read the models associated to the MTG from a YAML file:</p><pre><code class="language-julia hljs">file = joinpath(dirname(dirname(pathof(PlantBiophysics))), &quot;test&quot;, &quot;inputs&quot;, &quot;models&quot;, &quot;plant_coffee.yml&quot;)
models = read_model(file)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, ModelList} with 2 entries:
  &quot;Metamer&quot; =&gt; ModelList{NamedTuple{(:interception,), Tuple{Translucent{Float64…
  &quot;Leaf&quot;    =&gt; ModelList{NamedTuple{(:energy_balance, :interception, :photosynt…</code></pre><p>Let&#39;s check which variables we need to provide for our model configuration:</p><pre><code class="language-julia hljs">to_initialize(models)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, Tuple{Vararg{Symbol}}} with 1 entry:
  &quot;Leaf&quot; =&gt; (:Rₛ, :sky_fraction, :d, :PPFD)</code></pre><p>OK, only the <code>&quot;Leaf&quot;</code> component must be initialized before computation, with the shortwave radiation <code>Rₛ</code>, the visible sky fraction seen by the object <code>sky_fraction</code>, the characteristic dimension of the object <code>d</code> and the Photosynthetically active Photon Flux Density <code>PPFD</code>. We are in luck, we used <a href="https://archimed-platform.github.io/archimed-phys-user-doc/">Archimed-ϕ</a> to compute the radiation interception of each organ in the example coffee plant we are using. So the only thing we need is to transform the variables given by Archimed-ϕ in each node to compute the ones we need. We use <code>transform!</code> from <code>MultiScaleTreeGraph.jl</code> to traverse the MTG and compute the right variable for each node:</p><pre><code class="language-julia hljs">using MultiScaleTreeGraph

transform!(
    mtg,
    [:Ra_PAR_f, :Ra_NIR_f] =&gt; ((x, y) -&gt; x + y) =&gt; :Rₛ,
    :Ra_PAR_f =&gt; (x -&gt; x * 4.57) =&gt; :PPFD,
    (x -&gt; 0.3) =&gt; :d,
    ignore_nothing = true
)</code></pre><p>The design of <code>MultiScaleTreeGraph.transform!</code> is very close to the one adopted by <code>DataFrames</code>. It helps us compute new variables (or attributes) from others, modify their units or rename them. Here we compute <code>Rₛ</code> from the sum of <code>Ra_PAR_f</code> (absorbed radiation flux in the PAR) and <code>Ra_NIR_f</code> (...in the NIR), <code>PPFD</code> from <code>Ra_PAR_f</code> using the conversion between <span>$W \cdot m^{2}$</span> to <span>$μmol \cdot m^{-2} \cdot s^{-1}$</span>, and <code>d</code> using a constant value of 0.3 m. Note that <code>sky_fraction</code> is already computed for each node with the right units thanks to Archimed-ϕ, so no need to transform it.</p><p>Then <code>PlantBiophysics.jl</code> takes care of the rest and simulates the energy balance over each time-step:</p><pre><code class="language- hljs">energy_balance!(mtg, models, weather)</code></pre><p>We can visualize the outputs in 3D using PlantGeom&#39;s <code>viz</code> function. To do so we have to extract the time step we want to use for coloring the organs. For example if we want to color the plant according to the value of the temperature from the first time-step, we would do:</p><pre><code class="language-julia hljs">transform!(
    mtg,
    :Tₗ =&gt; (x -&gt; x[1]) =&gt; :Tₗ_1,
    ignore_nothing = true
)</code></pre><p>And then actually plotting it:</p><pre><code class="language- hljs">f, ax, p = viz(mtg, color = :Tₗ_1)
colorbar(f[1, 2], p)
f</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../several_objects_simulation/">« Several objects</a><a class="docs-footer-nextpage" href="../uncertainty_propagation/">Tutorial: Uncertainty propagation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.14 on <span class="colophon-date" title="Friday 2 September 2022 08:11">Friday 2 September 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
